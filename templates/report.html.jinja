{% extends "layout/default.html.jinja" %}

{% macro mark_exists(entry) %}
    {% if entry %}
    <i title="present" class="fas fa-lg fa-check-circle text-itp-green"></i>
    {% else %}
    <i title="missing" class="far fa-lg fa-circle text-itp-slate-light"></i>
    {% endif %}
{% endmacro %}

{% macro display_figure(label, value) %}
    <figure>
        <div class="text-4xl text-itp-teal-bold">{{value}}</div>
        <figcaption class="text-itp-slate-bold">{{label}}</figcaption>
    </figure>
{% endmacro %}

{%- block title -%}
Monthly GTFS Quality Reports: {{parameters["DATE_MONTH_YEAR"]}} {{parameters["AGENCY_NAME"]}}
{%- endblock -%}

{% block content %}
<div class="responsive-prose">
    <h1>
        Monthly GTFS Quality Report
        <br>
        <small>
            <a href="{{ feed_info.feed_publisher_url }}">{{ parameters["AGENCY_NAME"] }}</a>
            &hairsp;&middot;&hairsp;
            {{ date_generated }}
        </small>
    </h1>
    <p class="lead responsive-prose">
        This is a monthly report, generated by the California Integrated Travel Project
        (Cal-ITP), summarizing issues discovered by MobilityDataâ€™s GTFS Validator. This report
        is available for viewing by the general public to support continuous improvement of
        GTFS data and the experience of transit passengers.
    </p>
</div>

<div class="my-8">
    <a class="btn responsive-prose mr-4 mb-4" href="{{ status.gtfs_schedule_url }}">
        <i class="fas fa-link mr-1 text-itp-slate-bold"></i>
        Download Feed
    </a>
</div>

<hr>

<div class="flex flex-col lg:flex-row gap-12 lg:gap-16 xl:gap-24 2xl:gap-36">
    <div>
        <div class="flex flex-wrap lg:flex-col gap-12">
            {{ display_figure('Feed Published', feed_info.feed_version) }}
            {{ display_figure('Feed Downloaded', feed_info.feed_end_date) }}
            {{ display_figure('Days Expired', n_expired_days.n) }}
            {{ display_figure('Routes', feed_info.n_routes) }}
            {{ display_figure('Stops', feed_info.n_stops) }}
        </div>
        <hr class="lg:hidden mb-0">
    </div>

    <div class="flex-1 responsive-prose">
        <h2>Aggregated metrics for&nbsp; {{parameters["DATE_MONTH"]}}</h2>
        <ul>
            <li>Service hours per day in the active&nbsp;feed:</li>
        </ul>
        <img src="2_service_hours.png">
    </div>

    <div class="flex-1 responsive-prose">
        <h2>Changes from {{parameters["START_MONTH_DAY"]}} to {{parameters["END_MONTH_DAY"]}}</h2>
        <ul>
            <li>Percentage of stop and route IDs that have changed since the previous&nbsp;month.</li>
            <li>More than 5% being new or dropped is a cause for&nbsp;attention.</li>
        </ul>
        <img src="3_id_changes.png">
    </div>
</div>

<hr>

<div class="responsive-prose max-w-none">
    <h2>Consistency with the California GTFS Minimum Guidelines</h2>


    <table>
        <thead>
            <tr>
                <th colspan="2">Do the following files/fields exist?</th>
                <th>{{ file_check["columns"][2]}}</th>
                <th>{{ file_check["columns"][3]}}</th>
                <th>{{ file_check["columns"][4]}}</th>
            </tr>
        </thead>
        <tbody>
            {% for row in file_check["data"] %}
            <tr>
                {% set rowspan = file_check["rowspan"][loop.index0] %}
                {% if rowspan %}
                <th class="font-normal text-itp-slate-bold" rowspan="{{rowspan}}">{{row[0]}}</th>
                {% endif %}
                <td>{{row[1]}}</td>
                <!-- these are the date columns -->
                <td>{{mark_exists(row[2])}}</td>
                <td>{{mark_exists(row[3])}}</td>
                <td>{{mark_exists(row[4])}}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <table>
        <thead>
            <tr>
                <th colspan="2">Validation errors observed</th>
            </tr>
        </thead>
        <tbody>
            {% for row in validation_notices["data"] %}
            <tr>
                {% for col in row %}
                <td>{{ col }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


{% endblock %}
