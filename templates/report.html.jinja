{% extends "layout/default.html.jinja" %}

{% macro mark_exists(entry) %}
    {% if entry %}
    <i title="present" class="fas fa-lg fa-check-circle text-itp-green"></i>
    {% else %}
    <i title="missing" class="far fa-lg fa-circle text-itp-slate-light"></i>
    {% endif %}
{% endmacro %}

{% macro display_figure(label, value) %}
    <figure>
        <div class="text-2xl text-itp-teal-bold">{{value}}</div>
        <figcaption class="text-itp-slate-bold">{{label}}</figcaption>
    </figure>
{% endmacro %}

{%- block title -%}
Monthly GTFS Quality Reports: {{parameters["DATE_MONTH_YEAR"]}} {{parameters["AGENCY_NAME"]}}
{%- endblock -%}

{% block content %}
<div class="responsive-prose">
    <h1>
        Monthly GTFS Quality Report
        <br>
        <small>
          {% if feed_info.has_feed_info %}
            <a href="{{ feed_info.feed_publisher_url }}">{{ parameters["AGENCY_NAME"] }}</a>
          {% else %}
            {{ parameters["AGENCY_NAME"] }}
          {% endif %}
            &hairsp;&middot;&hairsp;
            <span class="inline-block">{{parameters["DATE_MONTH_YEAR"]}}</span>
        </small>
    </h1>
    <p class="lead responsive-prose">
        This is a monthly report, generated by the California Integrated Travel Project
        (Cal-ITP), summarizing issues discovered by MobilityDataâ€™s GTFS Validator. This report
        is available for viewing by the general public to support continuous improvement of
        GTFS data and the experience of transit passengers.
    </p>
</div>

<hr>

<div class="flex-1 responsive-prose gap-12 lg:gap-16">
    <h2>Current GTFS Feed Info </h2>
        <div class="flex flex-row lg:flex-row flex-wrap gap-24">
            {{ display_figure('Feed End Date', feed_info.feed_end_date) }}
            {{ display_figure('Days With No Service', n_days_no_service.n) }}
            {{ display_figure('Routes', feed_info.n_routes) }}
            {{ display_figure('Stops', feed_info.n_stops) }}
        </div>
        {% if not feed_info.has_feed_info %}
        <div class="flex flex-row lg:flex-row flex-wrap gap-24">
            <ul>
                <li>This feed appears to be missing&nbsp;<a href='https://gtfs.org/schedule/best-practices/#feed_infotxt'>feed_info.txt</a>.
                <li>Including feed info is important to help data users easily find technical&nbsp;contacts.</li>
                <li>Please reach out to our help desk at hello@calitp.org with any&nbsp;questions.</li>
            </ul>
        </div>
        {% endif %}
    </div>

{# Commented out until an ultimate resolution can be found for
  https://github.com/cal-itp/reports/issues/44
<div class="my-8">
    <a class="btn responsive-prose mr-4 mb-4" href="{{ status.gtfs_schedule_url }}">
        <i class="fas fa-link mr-1 text-itp-slate-bold"></i>
        Download Feed
    </a>
</div>
#}

<hr>


<div class="flex flex-col lg:flex-row gap-12 lg:gap-16 xl:gap-24 2xl:gap-36">
    <div class="flex-1 responsive-prose">
        <h2>About the {{parameters["DATE_MONTH"]}} Daily Service Level&nbsp;Charts</h2>
        <ul>
            <li>These charts show the total hours of transit service described by the active feed for each&nbsp;day.</li>
            <li>Since service levels often vary by the day of the week, it is split into three charts for weekdays, Saturdays, and&nbsp;Sundays.</li>
            <li>Flat lines indicate consistent levels of service throughout the&nbsp;month.</li>
            <li>Short drops may indicate temporary reduced service, such as for holidays, gaps in feed publishing, or potential&nbsp;inaccuracies.</li>
            <li>Please reach out to our help desk at hello@calitp.org with any&nbsp;questions.</li>
        </ul>
    </div>

    <div class="flex-1 responsive-prose">
        <h2>Service hours per weekday in the active&nbsp;feed:</h2>
        <img src="2_service_hours_wk.png">
    </div>
</div>

<div class="flex flex-col lg:flex-row gap-12 lg:gap-16 xl:gap-24 2xl:gap-36">
    <div class="flex-1 responsive-prose">
        <h2>Service hours per Saturday in the active&nbsp;feed:</h2>
        <img src="2_service_hours_sa.png">
    </div>

    <div class="flex-1 responsive-prose">
        <h2>Service hours per Sunday in the active&nbsp;feed:</h2>
        <img src="2_service_hours_su.png">
    </div>

</div>

<hr>

<div class="flex flex-col lg:flex-row gap-12 lg:gap-16 xl:gap-24 2xl:gap-36">

    <div class="flex-1 responsive-prose">
        <h2>About the {{parameters["DATE_MONTH"]}} Identifier Change&nbsp;Charts</h2>
        <ul>
            <li>These charts show the percentage of stop and route IDs that have changed since the previous&nbsp;month.</li>
            <li>Stop and route IDs are important identifiers for GTFS feed consumers to correctly parse&nbsp;feeds.</li>
            <li>It is a <a href="https://gtfs.org/schedule/best-practices/#dataset-publishing-general-practices"> GTFS Best Practice </a> to keep these consistent between feed versions whenever&nbsp;possible.</li>
            <li>More than 5% being new or dropped is a cause for attention, especially if there hasn't been a major service or route&nbsp;change.</li>
            <li>Please reach out to our help desk at hello@calitp.org with any&nbsp;questions.</li>
        </ul>
    </div>

    <div class="flex-1 responsive-prose">
        <h2>Changes from {{parameters["START_MONTH_DAY"]}} to {{parameters["END_MONTH_DAY"]}}</h2>
        <img src="3_id_changes.png">
    </div>
</div>

<hr>

<div class="responsive-prose max-w-none">
    <h2>Consistency with the California GTFS Minimum Guidelines</h2>

    <div class="overflow-x-auto -mx-8 px-8">
        <table>
            <!-- file checks -->
            <thead>
                <tr>
                    <th colspan="2">Do the following files/fields exist?</th>
                    <th class="whitespace-nowrap">{{ file_check["columns"][2]}}</th>
                    <th class="whitespace-nowrap">{{ file_check["columns"][3]}}</th>
                    {% if file_check["columns"][4] %}
                        <th class="whitespace-nowrap">{{ file_check["columns"][4]}}</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for row in file_check["data"] %}
                <tr>
                    {% set rowspan = file_check["rowspan"][loop.index0] %}
                    {% if rowspan %}
                    <th class="font-normal text-itp-slate-bold" rowspan="{{rowspan}}">{{row[0]}}</th>
                    {% endif %}
                    <td>{{row[1]}}</td>
                    <!-- these are the date columns -->
                    <td>{{mark_exists(row[2])}}</td>
                    <td>{{mark_exists(row[3])}}</td>
                    {% if row[4] %}
                        <td>{{mark_exists(row[4])}}</td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>

            <!-- validation severity errors -->

            {% if validation_severity is not defined %}

            {% elif "data" in validation_severity %}

            <thead class="border-t">
                <tr>
                    <th class="pt-12" colspan="2">Validation errors observed</th>
                </tr>
                <tr>
                    <th>Error Name</th>
                    <th>Error Description</th>
                    <th>{{ validation_severity["columns"][2] | title }}</th>
                    <th>{{ validation_severity["columns"][3]}}</th>
                </tr>
            </thead>
            <tbody>
                {% for row in validation_severity["data"] %}
                <tr>
                    {% for col in row %}
                    <td>{{ col }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
            {% else %}

             <p><b>No validation severity data is available for this period.</b></p>

            {% endif %}

    </div>


</div>

            <!-- validation errors -->

            {% if validation_notices["data"] %}

            <thead class="border-t">
                <tr>
                    <th class="pt-12" colspan="2">Cal-ITP validation errors observed</th>
                    <th class="pt-12" colspan="3"> Number of errors</th>
                </tr>
                <tr>
                    <th>Error Name</th>
                    <th>Error Description</th>
                    <th>{{ validation_notices["columns"][2]}}</th>
                    <th>{{ validation_notices["columns"][3]}}</th>
                    {% if validation_notices["columns"][4] %}
                    <th>{{ validation_notices["columns"][4]}}</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for row in validation_notices["data"] %}
                <tr>
                    {% for col in row %}
                    <td>{{ col }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>

            {% endif %}

        </table>
    </div>

    {% if not validation_notices["data"] %}

    <p><b>No validation errors detected.</b></p>

    {% endif %}

</div>


{% endblock %}
